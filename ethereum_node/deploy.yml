# NTP
- name: NTP time sync
  apt:
    name: chrony
    update_cache: yes
  become: yes
  tags:
    - ntp

# geth
- name: Copy geth executable
  copy: src={{geth_path}} dest=/home/ubuntu/geth
          owner=ubuntu group=ubuntu mode=0744
  tags:
    - geth

- name: Copy static nodes
  copy: src=./static-nodes.json dest=/home/ubuntu/eth_data/static-nodes.json
          owner=ubuntu group=ubuntu mode=0644
  tags:
    - geth

# Node exporter
- name: Copy node_exporter executable
  copy: src={{node_exporter_path}} dest=/home/ubuntu/node_exporter
          owner=ubuntu group=ubuntu mode=0744

# onramp
- name: Copy onramp executable
  copy: src={{onramp_path}} dest=/home/ubuntu/onramp
          owner=ubuntu group=ubuntu mode=0744
  tags:
    - onramp

- name: Copy key
  copy: src={{onramp_key_path}} dest=/home/ubuntu/pkey.ec.der
          owner=ubuntu group=ubuntu mode=0744
  tags:
    - onramp

# Supervisor
- name: Install supervisor
  apt:
    name: supervisor
    update_cache: yes
  become: yes

- name: Geth config file
  copy: src=./geth.conf dest=/etc/supervisor/conf.d/geth.conf
          owner=ubuntu group=ubuntu mode=0644
  become: yes

- name: Node exporter config file
  copy: src=./node_exporter.conf dest=/etc/supervisor/conf.d/node_exporter.conf
          owner=ubuntu group=ubuntu mode=0644
  become: yes

- name: OnRamp config file
  copy: src=./onramp.conf dest=/etc/supervisor/conf.d/onramp.conf
          owner=ubuntu group=ubuntu mode=0644
  become: yes

- name: Reload supervisor config
  command: supervisorctl reload
  become: yes

- name: Restart geth
  supervisorctl:
    name: geth
    state: restarted
  become: yes
  tags:
    - geth
